#!/bin/bash
#
# Formats tmux window name for display in status bar.
# - Hides "bash" (shows just the window number)
# - Detects version-like names and looks up actual process
#
# Usage: tmux-window-format --pane-tty <tty> <window_name>

# Parse arguments
pane_tty=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --pane-tty)
      pane_tty="$2"
      shift 2
      ;;
    *)
      window_name="$1"
      shift
      ;;
  esac
done

# pane_tty is required
if [[ -z "$pane_tty" ]]; then
  echo "name-error"
  exit 1
fi

# Detect Rails/Puma server with port (check before hiding bash)
# Check for puma process on this TTY and extract port from its args
rails_port=$(ps -o args= -t "$pane_tty" 2>/dev/null | grep -E 'puma.*\(tcp://[^:]+:[0-9]+\)' | grep -oE ':[0-9]+\)' | head -1 | tr -d ':)')
if [[ -n "$rails_port" ]]; then
  echo " rails:$rails_port"
  exit 0
fi

# For bash or version-like window names, look up the actual foreground process.
# - "bash" appears when the shell is running a foreground command (like claude)
# - Version patterns (e.g., "2.0.76") appear when apps set their process title
if [[ "$window_name" == "bash" || "$window_name" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
  # Find foreground process (marked with + in STAT) on this TTY, skipping bash
  # Use args= instead of comm= to get full path (comm= truncates /opt/homebrew/bin/bash to /opt/homebrew/bi)
  actual_cmd=$(ps -o stat=,args= -t "$pane_tty" 2>/dev/null | awk '
    $1 ~ /\+/ {
      cmd = $2
      n = split(cmd, parts, "/")
      name = parts[n]
      if (name != "bash") { print name; exit }
    }
  ')
  if [[ -n "$actual_cmd" ]]; then
    window_name="$actual_cmd"
  elif [[ "$window_name" == "bash" ]]; then
    # No foreground process found and window name was bash - hide it
    echo ""
    exit 0
  fi
fi

echo " $window_name"
