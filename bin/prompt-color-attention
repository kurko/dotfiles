#!/bin/bash
#
# Changes tmux pane background to grab attention when a program needs input.
# Use ANNOYING_COLOR_ALERT=1 to enable.
#
# Usage:
#   prompt-color-attention           # Activates attention color (if enabled)
#   prompt-color-attention --disable # Resets to default
#
# Color alternatives:
#   Green (current): bg=#74C476,fg=#00441B
#   Dark orange:     bg=#3d2000,fg=#ffffff
#   Bright orange:   bg=#FF8C00,fg=#000000
#   Red alert:       bg=#8B0000,fg=#ffffff
#   Yellow:          bg=#FFD700,fg=#000000

LOG="/tmp/prompt-color-attention.log"

[[ -z "$TMUX" ]] && exit 0

# Use exported pane ID if available (from prompt-attention wrapper),
# then TMUX_PANE (inherited env var, more reliable than display-message),
# finally fall back to tmux display-message
if [[ -n "$ANNOYING_PANE_ID" ]]; then
  PANE_ID="$ANNOYING_PANE_ID"
elif [[ -n "$TMUX_PANE" ]]; then
  PANE_ID="${TMUX_PANE#%}"
else
  PANE_ID=$(tmux display-message -p '#{pane_id}' | tr -d '%')
fi

ALERT_FLAG_FILE="/tmp/annoying-color-alert-$PANE_ID"

# --disable: Only act if alert is active (flag file exists).
# Safe to call on every Enter keypress - no-op without flag file.
if [[ "$1" == "--disable" ]]; then
  [[ ! -f "$ALERT_FLAG_FILE" ]] && exit 0
  echo "$(date): disable PANE_ID=$PANE_ID" >> "$LOG"
  tmux select-pane -t "%$PANE_ID" -P 'bg=default,fg=default'
  rm -f "$ALERT_FLAG_FILE"
  exit 0
fi

# Enable path - log for debugging
echo "$(date): enable PANE_ID=$PANE_ID flag_exists=$(test -f "$ALERT_FLAG_FILE" && echo yes || echo no)" >> "$LOG"

if [[ "$ANNOYING_COLOR_ALERT" == "1" ]] || [[ -f "$ALERT_FLAG_FILE" ]]; then
  echo "Setting tmux pane to attention color."
  touch "$ALERT_FLAG_FILE"
  tmux select-pane -t "%$PANE_ID" -P 'bg=#FF8C00,fg=#ffffff'
else
  echo "ANNOYING_COLOR_ALERT is not enabled. No changes made."
fi
